<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Query Generation â€¢ rquery</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Query Generation">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rquery</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/AssigmentPartitioner.html">Assignment Partitioner</a>
    </li>
    <li>
      <a href="../articles/Parameterized_rquery.html">Parameterized rquery</a>
    </li>
    <li>
      <a href="../articles/PipeableSQL.html">Pipeable SQL</a>
    </li>
    <li>
      <a href="../articles/QueryGeneration.html">Query Generation</a>
    </li>
    <li>
      <a href="../articles/rquery_intro.html">rquery Introduction</a>
    </li>
    <li>
      <a href="../articles/sql_quoting.html">SQL quoting</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/WinVector/rquery/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Query Generation</h1>
                        <h4 class="author">John Mount</h4>
            
            <h4 class="date">2019-01-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/rquery//blob/master/vignettes/QueryGeneration.Rmd"><code>vignettes/QueryGeneration.Rmd</code></a></small>
      <div class="hidden name"><code>QueryGeneration.Rmd</code></div>

    </div>

    
    
<p>This is a very brief place-holder example (not executed, as <code>SQLite</code> does not have the needed window functions). For more details please see the fuller note: <a href="https://winvector.github.io/rquery/index.html"><code>rquery README</code></a>.</p>
<p>The primary purpose of <code>rquery</code> is <code>SQL</code> query generation. We demonstrate this below.</p>
<p>Note: in examples we use <code><a href="../reference/rq_copy_to.html">rq_copy_to()</a></code> to create data. This is only for the purpose of having easy portable examples. With big data the data is usually already in the remote database or Spark system. The task is almost always to connect and work with this pre-existing remote data and the method to do this is <a href="https://winvector.github.io/rquery/reference/db_td.html"><code><a href="../reference/db_td.html">db_td()</a></code></a>, which builds a reference to a remote table given the table name.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># produce a hande to existing table</span>
d &lt;-<span class="st"> </span><span class="kw"><a href="../reference/db_td.html">db_td</a></span>(my_db, <span class="st">"d"</span>)

scale &lt;-<span class="st"> </span><span class="fl">0.237</span>

dq &lt;-<span class="st"> </span>d <span class="op">%.&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/extend.html">extend</a></span>(.,
         probability <span class="op">:</span><span class="er">=</span>
<span class="st">           </span><span class="kw">exp</span>(assessmentTotal <span class="op">*</span><span class="st"> </span>scale)<span class="op">/</span>
<span class="st">           </span><span class="kw">sum</span>(<span class="kw">exp</span>(assessmentTotal <span class="op">*</span><span class="st"> </span>scale)),
         count <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">count</span>(<span class="dv">1</span>),
         <span class="dt">partitionby =</span> <span class="st">'subjectID'</span>) <span class="op">%.&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/extend.html">extend</a></span>(.,
         rank <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">rank</span>(),
         <span class="dt">partitionby =</span> <span class="st">'subjectID'</span>,
         <span class="dt">orderby =</span> <span class="kw">c</span>(<span class="st">'probability'</span>, <span class="st">'surveyCategory'</span>))  <span class="op">%.&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/rename_columns.html">rename_columns</a></span>(., <span class="st">'diagnosis'</span> <span class="op">:</span><span class="er">=</span><span class="st"> 'surveyCategory'</span>) <span class="op">%.&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/select_rows.html">select_rows</a></span>(., rank <span class="op">==</span><span class="st"> </span>count) <span class="op">%.&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/select_columns.html">select_columns</a></span>(., <span class="kw">c</span>(<span class="st">'subjectID'</span>, 
                      <span class="st">'diagnosis'</span>, 
                      <span class="st">'probability'</span>)) <span class="op">%.&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/orderby.html">orderby</a></span>(., <span class="st">'subjectID'</span>)

<span class="kw">class</span>(my_db)
<span class="co">#&gt; [1] "SQLiteConnection"</span>
<span class="co">#&gt; attr(,"package")</span>
<span class="co">#&gt; [1] "RSQLite"</span></code></pre></div>
<p>Presentation format (see also <a href="https://winvector.github.io/rquery/reference/op_diagram.html"><code><a href="../reference/op_diagram.html">op_diagram()</a></code></a>):</p>
<pre><code>  table(`d`; 
    subjectID,
    surveyCategory,
    assessmentTotal,
    irrelevantCol1,
    irrelevantCol2) %.&gt;%
   extend(.,
    probability := exp(assessmentTotal * 0.237) / sum(exp(assessmentTotal * 0.237)),
    count := count(1),
    p= subjectID) %.&gt;%
   extend(.,
    rank := rank(),
    p= subjectID,
    o= "probability", "surveyCategory") %.&gt;%
   rename(.,
    c('diagnosis' = 'surveyCategory')) %.&gt;%
   select_rows(.,
     rank == count) %.&gt;%
   select_columns(.,
     subjectID, diagnosis, probability) %.&gt;%
   orderby(., subjectID)</code></pre>
<p><code><a href="../reference/to_sql.html">to_sql()</a></code> SQL (see also <a href="https://winvector.github.io/rquery/reference/materialize.html"><code><a href="../reference/materialize.html">materialize()</a></code></a>):</p>
<pre><code>  SELECT * FROM (
   SELECT
    `subjectID`,
    `diagnosis`,
    `probability`
   FROM (
    SELECT * FROM (
     SELECT
      `subjectID` AS `subjectID`,
      `surveyCategory` AS `diagnosis`,
      `probability` AS `probability`,
      `count` AS `count`,
      `rank` AS `rank`
     FROM (
      SELECT
       `subjectID`,
       `surveyCategory`,
       `probability`,
       `count`,
       rank ( ) OVER (  PARTITION BY `subjectID` ORDER BY `probability`, `surveyCategory` ) AS `rank`
      FROM (
       SELECT
        `subjectID`,
        `surveyCategory`,
        exp ( `assessmentTotal` * 0.237 ) / sum ( exp ( `assessmentTotal` * 0.237 ) ) OVER (  PARTITION BY `subjectID` ) AS `probability`,
        count ( 1 ) OVER (  PARTITION BY `subjectID` ) AS `count`
       FROM (
        SELECT
         `subjectID`,
         `surveyCategory`,
         `assessmentTotal`
        FROM
         `d` LIMIT 1000
        ) tsql_47470795327861437088_0000000000
       ) tsql_47470795327861437088_0000000001
     ) tsql_47470795327861437088_0000000002
    ) tsql_47470795327861437088_0000000003
    WHERE `rank` = `count`
   ) tsql_47470795327861437088_0000000004
  ) tsql_47470795327861437088_0000000005 ORDER BY `subjectID`</code></pre>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
